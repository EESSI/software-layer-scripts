# Choose an EESSI CVMFS repository
set EESSI_CVMFS_REPO (set -q EESSI_CVMFS_REPO; and echo "$EESSI_CVMFS_REPO"; or echo "/cvmfs/software.eessi.io")
# Choose an EESSI version
set EESSI_VERSION_DEFAULT "__EESSI_VERSION_DEFAULT__"
set EESSI_VERSION (set -q EESSI_VERSION; and echo "$EESSI_VERSION"; or echo "$EESSI_VERSION_DEFAULT")
# Now that we know our EESSI version let's not forget it
set -x EESSI_VERSION_DEFAULT "$EESSI_VERSION"

# ability to predefine elsewhere the default list
set -x LMOD_SYSTEM_DEFAULT_MODULES (set -q LMOD_SYSTEM_DEFAULT_MODULE; and echo "$LMOD_SYSTEM_DEFAULT_MODULE"; or echo "EESSI/$EESSI_VERSION")

if test -z "$__Init_EESSI_Default_Modules"
    set -x __Init_EESSI_Default_Modules 1

    # If there is a local Lmod, make it forget about the system set MODULEPATH
    set -e __LMOD_REF_COUNT_MODULEPATH
    # and clear out any memory Lmod might have
    set -e _ModuleTable001_
    # Path to top-level module tree
    set -x MODULEPATH "$EESSI_CVMFS_REPO"/init/modules
    . "$EESSI_CVMFS_REPO"/versions/"$EESSI_VERSION"/compat/linux/(uname -m)/usr/share/Lmod/init/fish

    module --initial_load --no_redirect restore
else
    module reset
end
